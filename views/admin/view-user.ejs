<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-person-circle"></i> User Details</h2>
                <div>
                    <a href="/admin/users/<%= user.id %>/edit" class="btn btn-primary me-2">
                        <i class="bi bi-pencil"></i> Edit User
                    </a>
                    <a href="/admin/users" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Users
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- User Profile -->
                <div class="col-lg-4">
                    <div class="card shadow">
                        <div class="card-body text-center">
                            <% 
                                // Generate user initials for avatar
                                const initials = user.name.split(' ').map(n => n.charAt(0)).join('').toUpperCase().slice(0, 2);
                                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7', '#667eea'];
                                const colorIndex = user.name.charCodeAt(0) % colors.length;
                            %>
                            <div class="profile-avatar mx-auto mb-3" style="background: <%= colors[colorIndex] %>; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;">
                                <%= initials %>
                            </div>
                            <h4><%= user.name %></h4>
                            <p class="text-muted"><%= user.email %></p>
                            <p class="text-muted">
                                <i class="bi bi-whatsapp"></i> <%= user.whatsapp %>
                            </p>
                            <% if (user.is_admin) { %>
                                <span class="badge bg-danger">Administrator</span>
                            <% } else { %>
                                <span class="badge bg-primary">User</span>
                            <% } %>
                        </div>
                    </div>

                    <!-- Account Information -->
                    <div class="card shadow mt-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Account Information</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>User ID:</strong> <%= user.id %></p>
                            <p><strong>Balance:</strong> <span class="price-display" data-price-usd="<%= user.balance %>">$<%= parseFloat(user.balance).toFixed(2) %></span></p>
                            <p><strong>Joined:</strong> <%= new Date(user.created_at).toLocaleDateString() %></p>
                            <p><strong>Last Updated:</strong> <%= new Date(user.updated_at).toLocaleDateString() %></p>
                            <p><strong>Referral Code:</strong> <%= user.referral_code || 'None' %></p>
                            <% if (user.referred_by) { %>
                                <p><strong>Referred By ID:</strong> <%= user.referred_by %></p>
                            <% } %>
                            <p><strong>Security Question:</strong> <%= securityQuestion %></p>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="card shadow mt-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Statistics</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6 mb-3">
                                    <div class="border rounded p-2">
                                        <h4 class="text-primary mb-0"><%= stats.totalSongs %></h4>
                                        <small class="text-muted">Songs Uploaded</small>
                                    </div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="border rounded p-2">
                                        <h4 class="text-success mb-0"><%= stats.soldSongs %></h4>
                                        <small class="text-muted">Songs Sold</small>
                                    </div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="border rounded p-2">
                                        <h4 class="text-warning mb-0"><%= stats.totalPurchases %></h4>
                                        <small class="text-muted">Purchases Made</small>
                                    </div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="border rounded p-2">
                                        <h4 class="text-info mb-0"><%= stats.totalWithdrawals %></h4>
                                        <small class="text-muted">Withdrawals</small>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="row text-center">
                                <div class="col-6">
                                    <h5 class="text-success">$<%= stats.totalEarned.toFixed(2) %></h5>
                                    <small class="text-muted">Total Earned</small>
                                </div>
                                <div class="col-6">
                                    <h5 class="text-danger">$<%= stats.totalSpent.toFixed(2) %></h5>
                                    <small class="text-muted">Total Spent</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Information Tabs -->
                <div class="col-lg-8">
                    <div class="card shadow">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="userTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="songs-tab" data-bs-toggle="tab" data-bs-target="#songs" type="button" role="tab">
                                        <i class="bi bi-music-note"></i> Songs (<%= songs.length %>)
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="purchases-tab" data-bs-toggle="tab" data-bs-target="#purchases" type="button" role="tab">
                                        <i class="bi bi-cart"></i> Purchases (<%= purchases.length %>)
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab">
                                        <i class="bi bi-currency-dollar"></i> Sales (<%= sales.length %>)
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="withdrawals-tab" data-bs-toggle="tab" data-bs-target="#withdrawals" type="button" role="tab">
                                        <i class="bi bi-cash"></i> Withdrawals (<%= withdrawals.length %>)
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="userTabsContent">
                                <!-- Songs Tab -->
                                <div class="tab-pane fade show active" id="songs" role="tabpanel">
                                    <% if (songs.length === 0) { %>
                                        <div class="text-center py-4">
                                            <i class="bi bi-music-note fs-1 text-muted"></i>
                                            <p class="text-muted">No songs uploaded yet</p>
                                        </div>
                                    <% } else { %>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Title</th>
                                                        <th>Genre</th>
                                                        <th>Price</th>
                                                        <th>Status</th>
                                                        <th>Uploaded</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% songs.forEach(song => { %>
                                                        <tr>
                                                            <td><%= song.title %></td>
                                                            <td><%= song.genre.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) %></td>
                                                            <td>$<%= parseFloat(song.price).toFixed(2) %></td>
                                                            <td>
                                                                <% if (song.is_sold) { %>
                                                                    <span class="badge bg-success">Sold</span>
                                                                <% } else { %>
                                                                    <span class="badge bg-warning">Available</span>
                                                                <% } %>
                                                            </td>
                                                            <td><%= new Date(song.created_at).toLocaleDateString() %></td>
                                                            <td>
                                                                <a href="/songs/<%= song.id %>" class="btn btn-sm btn-outline-primary" target="_blank">View</a>
                                                            </td>
                                                        </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Purchases Tab -->
                                <div class="tab-pane fade" id="purchases" role="tabpanel">
                                    <% if (purchases.length === 0) { %>
                                        <div class="text-center py-4">
                                            <i class="bi bi-cart fs-1 text-muted"></i>
                                            <p class="text-muted">No purchases made yet</p>
                                        </div>
                                    <% } else { %>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Song</th>
                                                        <th>Artist</th>
                                                        <th>Amount</th>
                                                        <th>Date</th>
                                                        <th>Transaction ID</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% purchases.forEach(purchase => { %>
                                                        <tr>
                                                            <td><%= purchase.song_title %></td>
                                                            <td><%= purchase.artist_name %></td>
                                                            <td>$<%= parseFloat(purchase.amount).toFixed(2) %></td>
                                                            <td><%= new Date(purchase.created_at).toLocaleDateString() %></td>
                                                            <td><%= purchase.flutterwave_tx_ref %></td>
                                                        </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Sales Tab -->
                                <div class="tab-pane fade" id="sales" role="tabpanel">
                                    <% if (sales.length === 0) { %>
                                        <div class="text-center py-4">
                                            <i class="bi bi-currency-dollar fs-1 text-muted"></i>
                                            <p class="text-muted">No sales made yet</p>
                                        </div>
                                    <% } else { %>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Song</th>
                                                        <th>Buyer</th>
                                                        <th>Total Amount</th>
                                                        <th>Your Earnings</th>
                                                        <th>Date</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% sales.forEach(sale => { %>
                                                        <tr>
                                                            <td><%= sale.song_title %></td>
                                                            <td><%= sale.buyer_name || sale.buyer_email %></td>
                                                            <td>$<%= parseFloat(sale.amount).toFixed(2) %></td>
                                                            <td>$<%= parseFloat(sale.seller_amount).toFixed(2) %></td>
                                                            <td><%= new Date(sale.created_at).toLocaleDateString() %></td>
                                                        </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    <% } %>
                                </div>

                                <!-- Withdrawals Tab -->
                                <div class="tab-pane fade" id="withdrawals" role="tabpanel">
                                    <% if (withdrawals.length === 0) { %>
                                        <div class="text-center py-4">
                                            <i class="bi bi-cash fs-1 text-muted"></i>
                                            <p class="text-muted">No withdrawal requests yet</p>
                                        </div>
                                    <% } else { %>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Amount</th>
                                                        <th>Method</th>
                                                        <th>Status</th>
                                                        <th>Requested</th>
                                                        <th>Processed</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% withdrawals.forEach(withdrawal => { %>
                                                        <tr>
                                                            <td>$<%= parseFloat(withdrawal.amount).toFixed(2) %></td>
                                                            <td><%= withdrawal.payment_method %></td>
                                                            <td>
                                                                <% if (withdrawal.status === 'pending') { %>
                                                                    <span class="badge bg-warning">Pending</span>
                                                                <% } else if (withdrawal.status === 'approved') { %>
                                                                    <span class="badge bg-success">Approved</span>
                                                                <% } else { %>
                                                                    <span class="badge bg-danger">Rejected</span>
                                                                <% } %>
                                                            </td>
                                                            <td><%= new Date(withdrawal.created_at).toLocaleDateString() %></td>
                                                            <td><%= withdrawal.processed_at ? new Date(withdrawal.processed_at).toLocaleDateString() : '-' %></td>
                                                        </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
